<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:HaircutHistoryApp.ViewModels"
             xmlns:models="clr-namespace:HaircutHistoryApp.Models"
             x:Class="HaircutHistoryApp.Views.AddEditProfilePage"
             x:DataType="vm:AddEditProfileViewModel"
             Title="{Binding Title}"
             BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Save" Command="{Binding SaveCommand}"/>
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="15">

            <!-- Name & Notes Section -->
            <Frame Padding="15"
                   BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                   BorderColor="Transparent"
                   CornerRadius="12">
                <VerticalStackLayout Spacing="12">
                    <!-- Name -->
                    <Entry Placeholder="Profile Name"
                           Text="{Binding Name}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>

                    <!-- Notes -->
                    <Editor Placeholder="Notes (optional)"
                            Text="{Binding Description}"
                            HeightRequest="60"
                            FontSize="14"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Reference Photos (3 slots) -->
            <Frame Padding="15"
                   BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                   BorderColor="Transparent"
                   CornerRadius="12">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Reference Photos"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>

                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                        <!-- Image 1 -->
                        <Border Grid.Column="0"
                                StrokeShape="RoundRectangle 8"
                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                HeightRequest="100">
                            <Grid>
                                <Image Source="{Binding ImageUrl1}"
                                       Aspect="AspectFill"
                                       IsVisible="{Binding HasImage1}"/>
                                <Label Text="+"
                                       FontSize="32"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       IsVisible="{Binding HasImage1, Converter={StaticResource InvertedBoolConverter}}"/>
                                <!-- Remove button -->
                                <Button Text="X"
                                        FontSize="10"
                                        WidthRequest="24"
                                        HeightRequest="24"
                                        CornerRadius="12"
                                        Padding="0"
                                        BackgroundColor="{StaticResource Danger}"
                                        TextColor="White"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"
                                        Margin="4"
                                        Command="{Binding RemoveImage1Command}"
                                        IsVisible="{Binding HasImage1}"/>
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding PickImage1Command}"/>
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Border>

                        <!-- Image 2 -->
                        <Border Grid.Column="1"
                                StrokeShape="RoundRectangle 8"
                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                HeightRequest="100">
                            <Grid>
                                <Image Source="{Binding ImageUrl2}"
                                       Aspect="AspectFill"
                                       IsVisible="{Binding HasImage2}"/>
                                <Label Text="+"
                                       FontSize="32"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       IsVisible="{Binding HasImage2, Converter={StaticResource InvertedBoolConverter}}"/>
                                <Button Text="X"
                                        FontSize="10"
                                        WidthRequest="24"
                                        HeightRequest="24"
                                        CornerRadius="12"
                                        Padding="0"
                                        BackgroundColor="{StaticResource Danger}"
                                        TextColor="White"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"
                                        Margin="4"
                                        Command="{Binding RemoveImage2Command}"
                                        IsVisible="{Binding HasImage2}"/>
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding PickImage2Command}"/>
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Border>

                        <!-- Image 3 -->
                        <Border Grid.Column="2"
                                StrokeShape="RoundRectangle 8"
                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                HeightRequest="100">
                            <Grid>
                                <Image Source="{Binding ImageUrl3}"
                                       Aspect="AspectFill"
                                       IsVisible="{Binding HasImage3}"/>
                                <Label Text="+"
                                       FontSize="32"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       IsVisible="{Binding HasImage3, Converter={StaticResource InvertedBoolConverter}}"/>
                                <Button Text="X"
                                        FontSize="10"
                                        WidthRequest="24"
                                        HeightRequest="24"
                                        CornerRadius="12"
                                        Padding="0"
                                        BackgroundColor="{StaticResource Danger}"
                                        TextColor="White"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"
                                        Margin="4"
                                        Command="{Binding RemoveImage3Command}"
                                        IsVisible="{Binding HasImage3}"/>
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding PickImage3Command}"/>
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Border>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Haircut Specs Section -->
            <Frame Padding="15"
                   BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                   BorderColor="Transparent"
                   CornerRadius="12">
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Haircut Specs"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                        <Button Grid.Column="1"
                                Text="+ Add"
                                Command="{Binding AddMeasurementCommand}"
                                FontSize="12"
                                HeightRequest="32"
                                Padding="12,0"
                                CornerRadius="16"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"/>
                    </Grid>

                    <!-- Empty State -->
                    <Label Text="No specs added yet"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                           HorizontalOptions="Center"
                           Margin="0,10"
                           IsVisible="{Binding HasMeasurements, Converter={StaticResource InvertedBoolConverter}}"/>

                    <!-- Specs List -->
                    <CollectionView ItemsSource="{Binding Measurements}"
                                    IsVisible="{Binding HasMeasurements}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:HaircutMeasurement">
                                <SwipeView>
                                    <SwipeView.RightItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Delete"
                                                       BackgroundColor="{StaticResource Danger}"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AddEditProfileViewModel}}, Path=RemoveMeasurementCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.RightItems>

                                    <Frame Margin="0,4"
                                           Padding="12"
                                           BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                           BorderColor="Transparent"
                                           CornerRadius="8">
                                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8" RowDefinitions="Auto,Auto" RowSpacing="8">
                                            <!-- Area Picker -->
                                            <Picker Grid.Column="0"
                                                    Title="Area"
                                                    SelectedItem="{Binding Area, Mode=TwoWay}"
                                                    ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type vm:AddEditProfileViewModel}}, Path=AreaOptions}"
                                                    FontSize="13"
                                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>

                                            <!-- Guard Size Picker -->
                                            <Picker Grid.Column="1"
                                                    Title="Guard"
                                                    SelectedItem="{Binding GuardSize, Mode=TwoWay}"
                                                    ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type vm:AddEditProfileViewModel}}, Path=GuardSizeOptions}"
                                                    FontSize="13"
                                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>

                                            <!-- Technique Picker -->
                                            <Picker Grid.Column="2"
                                                    Title="Technique"
                                                    SelectedItem="{Binding Technique, Mode=TwoWay}"
                                                    ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type vm:AddEditProfileViewModel}}, Path=TechniqueOptions}"
                                                    FontSize="13"
                                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>

                                            <!-- Notes -->
                                            <Entry Grid.Row="1" Grid.ColumnSpan="3"
                                                   Placeholder="Notes (optional)"
                                                   Text="{Binding Notes, Mode=TwoWay}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                                        </Grid>
                                    </Frame>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Save/Cancel Buttons -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="15" Margin="0,10,0,30">
                <Button Text="Cancel"
                        Command="{Binding CancelCommand}"
                        Style="{StaticResource SecondaryButton}"/>
                <Button Grid.Column="1"
                        Text="Save"
                        Command="{Binding SaveCommand}"
                        Style="{StaticResource PrimaryButton}"/>
            </Grid>

            <!-- Loading -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}"
                               Color="{StaticResource Primary}"
                               HorizontalOptions="Center"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
