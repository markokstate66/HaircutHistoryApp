name: Release

on:
  release:
    types: [published]

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  build-android-release:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install MAUI workload
      run: dotnet workload install maui-android

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '17'

    - name: Decode Keystore
      if: env.ANDROID_KEYSTORE_BASE64 != ''
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        echo $env:ANDROID_KEYSTORE_BASE64 | base64 -d > haircut-history.keystore

    - name: Restore dependencies
      run: dotnet restore src/HaircutHistoryApp/HaircutHistoryApp.csproj

    - name: Build and Sign Android APK
      run: |
        dotnet publish src/HaircutHistoryApp/HaircutHistoryApp.csproj `
          -f net10.0-android `
          -c Release `
          -p:AndroidKeyStore=true `
          -p:AndroidSigningKeyStore=haircut-history.keystore `
          -p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEY_ALIAS }} `
          -p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEY_PASSWORD }} `
          -p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

    - name: Upload Android Release
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: |
          src/HaircutHistoryApp/bin/Release/net10.0-android/publish/*.apk
          src/HaircutHistoryApp/bin/Release/net10.0-android/publish/*.aab

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          src/HaircutHistoryApp/bin/Release/net10.0-android/publish/*.apk
          src/HaircutHistoryApp/bin/Release/net10.0-android/publish/*.aab

  build-ios-release:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install MAUI workload
      run: dotnet workload install maui-ios

    - name: Install Apple Certificate
      if: env.IOS_P12_BASE64 != ''
      env:
        IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        # Create temp keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate
        echo $IOS_P12_BASE64 | base64 --decode > certificate.p12
        security import certificate.p12 -P "$IOS_P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

    - name: Restore dependencies
      run: dotnet restore src/HaircutHistoryApp/HaircutHistoryApp.csproj

    - name: Build iOS IPA
      run: |
        dotnet publish src/HaircutHistoryApp/HaircutHistoryApp.csproj \
          -f net10.0-ios \
          -c Release \
          -p:ArchiveOnBuild=true \
          -p:BuildIpa=true

    - name: Upload iOS Release
      uses: actions/upload-artifact@v4
      with:
        name: ios-release
        path: src/HaircutHistoryApp/bin/Release/net10.0-ios/publish/*.ipa

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: src/HaircutHistoryApp/bin/Release/net10.0-ios/publish/*.ipa
